generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  EMPLOYEE
  HR
  BUSINESS_HEAD
  ADMIN
}

enum Status {
  ACTIVE
  BLOCKED
}

enum LeaveType {
  CASUAL
  SICK
  PAID
  HALF_DAY
  FULL_DAY
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id                  Int       @id @default(autoincrement())
  email               String    @unique
  password            String
  name                String
  role                Role      @default(EMPLOYEE)
  designation         String    @default("LA") // LA, CRE, FA, AE
  status              Status    @default(ACTIVE)
  lastWorkLogDate     DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  attendance          Attendance[]
  workLogs            WorkLog[]
  leaveRequests       LeaveRequest[]
  permissionRequests  PermissionRequest[]
  loginAccessRequests LoginAccessRequest[]
  managedProjects     Project[]
}

model Attendance {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  date          DateTime @default(now())
  status        String   @default("PRESENT")
  checkoutTime  DateTime?
  checkInPhoto  String?  // URL/Path to the check-in photo
  checkoutPhoto String?  // URL/Path to the check-out photo
  createdAt     DateTime @default(now())

  @@unique([userId, date])
}

model WorkLog {
  id              Int      @id @default(autoincrement())
  userId          Int
  user            User     @relation(fields: [userId], references: [id])
  date            DateTime @default(now())
  projectId       Int?
  project         Project? @relation(fields: [projectId], references: [id])
  projectName     String?  // Can act as "Client Name" if needed, or specific field below
  
  // Architect Fields (LA)
  clientName      String?
  site            String?
  process         String?
  imageCount      Int?
  startTime       String?
  endTime         String?
  hours           Float?   // Keeping for backward compatibility/total time calculation
  completedImages Int?
  pendingImages   Int?
  
  // CRE Fields
  cre_totalCalls      Int?
  cre_showroomVisits  Int?
  cre_fqSent          Int?
  cre_orders          Int?
  cre_proposals       Int?
  cre_callBreakdown   String? // For storing the "9* - 2, 8* - 3" detailed breakdown as text

  // FA Fields
  fa_calls                   Int?
  fa_designPending           Int?
  fa_designPendingClients    String?
  fa_quotePending            Int?
  fa_quotePendingClients     String?
  fa_initialQuoteRn          Int?
  fa_revisedQuoteRn          Int?
  fa_showroomVisits          Int?
  fa_showroomVisitClients    String?
  fa_showroomTime            String? // Duration
  fa_onlineDiscussion        Int?
  fa_onlineDiscussionClients String?
  fa_onlineTime              String? // Duration
  fa_siteVisits              Int?
  fa_siteTime                String? // Duration
  fa_loadingDiscussion       Int?
  fa_bookingFreezed          Int?
  fa_bookingFreezedClients   String?

  // Loading Architect (LA) Detailed Fields
  la_number           String?
  la_mailId           String?
  la_projectLocation  String?
  la_freezingAmount   String?
  la_variant          String?
  la_projectValue     String?
  la_woodwork         String?
  la_addOns           String?
  la_cpCode           String?
  la_source           String?
  la_fa               String?
  la_referalBonus     String?
  la_siteStatus       String?
  la_specialNote      String?

  // JSON fields for tables/lists
  la_requirements     Json?     // List of requirements strings
  la_colours          Json?     // List of colour strings
  la_onlineMeeting    Json?     // Array of { slNo, date, discussedOn }
  la_showroomMeeting  Json?     // Array of { slNo, date, discussedOn }
  la_measurements     Json?     // Array of { aeName, date, discussedOn }
  
  // Generic field for new roles
  customFields        Json?

  // AE Fields (Application Engineer)
  ae_siteLocation     String?
  ae_gpsCoordinates   String?
  ae_siteStatus       String?   // New Site, Ongoing, Handover, Hold
  ae_visitType        Json?     // ["Site Inspection", "Measurement", ...]
  ae_workStage        String?   // Design, Production, Installation, Finishing
  ae_tasksCompleted   Json?     // ["Measurement Taken", "Material Delivered", ...]
  ae_measurements     String?   // Quantity
  ae_itemsInstalled   String?   // Quantity
  ae_issuesRaised     String?   // Quantity
  ae_issuesResolved   String?   // Quantity
  ae_hasIssues        Boolean?  @default(false)
  ae_issueType        String?   // Design, Material, Site, Client
  ae_issueDescription String?
  ae_nextVisitRequired Boolean? @default(false)
  ae_nextVisitDate    DateTime?
  ae_plannedWork      String?
  ae_clientMet        Boolean?  @default(false)
  ae_clientFeedback   String?   // Positive, Neutral, Negative
  ae_photos           Json?     // Array of photo URLs or filenames

  tasks           String?   // Making optional if 'process' takes over
  remarks         String?
  createdAt       DateTime @default(now())
}

model LeaveRequest {
  id        Int           @id @default(autoincrement())
  userId    Int
  user      User          @relation(fields: [userId], references: [id])
  type      LeaveType
  startDate DateTime
  endDate   DateTime
  reason    String
  status    RequestStatus @default(PENDING) // Overall Status (Pending until HR approves)
  
  // Approval Workflow
  bhStatus  RequestStatus @default(PENDING)
  hrStatus  RequestStatus @default(PENDING)
  bhId      Int?          // ID of Business Head who approved
  targetBhId Int?         // ID of Business Head assigned to approve
  hrId      Int?          // ID of HR who approved
  
  approvedBy Int?         // Legacy field (can remove later or map to hrId)
  createdAt DateTime      @default(now())
}

model PermissionRequest {
  id        Int           @id @default(autoincrement())
  userId    Int
  user      User          @relation(fields: [userId], references: [id])
  date      DateTime
  startTime String
  endTime   String
  reason    String
  status    RequestStatus @default(PENDING) // Overall Status
  
  // Approval Workflow
  bhStatus  RequestStatus @default(PENDING)
  hrStatus  RequestStatus @default(PENDING)
  bhId      Int?
  targetBhId Int?         // ID of Business Head assigned to approve
  hrId      Int?

  approvedBy Int?
  createdAt DateTime      @default(now())
}

model LoginAccessRequest {
  id        Int           @id @default(autoincrement())
  userId    Int
  user      User          @relation(fields: [userId], references: [id])
  reason    String
  status    RequestStatus @default(PENDING)
  createdAt DateTime      @default(now())
}

model Project {
  id              Int       @id @default(autoincrement())
  name            String
  description     String?
  managerId       Int?
  manager         User?     @relation(fields: [managerId], references: [id])
  
  // LA Project Fields
  number          String?
  mailId          String?
  location        String?
  latitude        Float?
  longitude       Float?
  freezingAmount  String?
  variant         String?
  projectValue    String?
  woodwork        String?
  addOns          String?
  cpCode          String?
  source          String?
  fa              String?
  referalBonus    String?
  siteStatus      String?
  specialNote     String?
  
  // JSON fields for lists/tables
  requirements    Json?
  colours         Json?
  onlineMeeting   Json?
  showroomMeeting Json?
  measurements    Json?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt @default(now())

  workLogs        WorkLog[]
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  action    String
  userId    Int?
  details   String?
  createdAt DateTime @default(now())
}

model CEOQuote {
  id        Int      @id @default(autoincrement())
  imageUrl  String
  quote     String
  author    String
  createdAt DateTime @default(now())
}
